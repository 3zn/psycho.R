{
    "collab_server" : "",
    "contents" : "#' Analyze stanreg objects.\n#'\n#' Analyze stanreg objects.\n#'\n#' @param x stanreg object.\n#' @param CI Credible interval bounds.\n#' @param MPE_step The step used for computing Maximum Probability Effect (MPE).\n#' @param MPE_min The lower bound of MPE (the minimum effect).\n#' @param Effect_Size Compute Effect Sizes according to Cohen (1988)? Your outcome variable must be standardized.\n#' @param ... Arguments passed to or from other methods.\n#'\n#' @return output\n#'\n#' @examples\n#' library(psycho)\n#' require(rstanarm)\n#' fit <- rstanarm::stan_glm(vs ~ mpg * cyl,\n#'   data=mtcars,\n#'   family = binomial(link = \"logit\"),\n#'   prior=NULL)\n#'\n#'  analyze(fit)\n#'\n#' @author Dominique Makowski, \\url{https://dominiquemakowski.github.io/}\n#'\n#' @import rstanarm\n#' @import tidyr\n#' @import dplyr\n#' @import ggplot2\n#' @importFrom stats quantile\n#' @export\nanalyze.stanreg <- function(x, CI=95, MPE_step=0.05, MPE_min=0.01, Effect_Size=FALSE, ...) {\n\n\n  # Processing\n  # -------------\n  fit <- x\n\n  # Extract posterior distributions\n  posteriors <- as.data.frame(fit)\n\n  # Varnames\n  varnames <- names(fit$coefficients)\n  varnames <- varnames[grepl(\"b\\\\[\", varnames)==FALSE]\n\n\n  # Initialize empty values\n  values <- list()\n  # Loop over all variables\n  for (varname in varnames){\n\n    # Extract posterior\n    posterior <- posteriors[, varname]\n\n    # Find basic posterior indices\n    median=median(posterior)\n    mad=mad(posterior)\n    mean <- mean(posterior)\n    sd <- sd(posterior)\n    CI_values <- quantile(posterior, c((100-CI)/2/100, 1-(100-CI)/2/100))\n\n    # Compute MPE\n    for (MPE in seq(0, 100, by = MPE_step)){\n      MPE_values <- 100-MPE\n      MPE_values <- quantile(posterior, c(0+MPE_values/2/100, 1-MPE_values/2/100))\n\n      if (median >= 0){\n        if (MPE_values[1] <= MPE_min){\n          break\n        }\n      } else {\n        if (MPE_values[2] >= -MPE_min){\n          break\n        }\n      }\n    }\n\n    # Create text\n    if (grepl(\":\", varname)){\n      splitted <- strsplit(varname, \":\")[[1]]\n      if (length(splitted)==2){\n        name <- paste(\"interaction effect between \", splitted[1], \" and \", splitted[2], sep=\"\")\n      } else{\n          name <- varname\n        }\n      } else{\n        name <- paste(\"effect of \", varname, sep=\"\")\n    }\n\n    text <- paste(\"Concerning the \", name, \", there is a probability of \", format_digit(MPE), \"% that its coefficient is between \", format_digit(MPE_values[1]), \" and \", format_digit(MPE_values[2]), \" (Median = \", format_digit(median), \", MAD = \", format_digit(mad), \", Mean = \", format_digit(mean), \", SD = \", format_digit(sd), \", \", CI, \"% CI [\", format_digit(CI_values[1]), \", \", format_digit(CI_values[2]), \"]).\", sep=\"\")\n\n    # Store all that\n    values[[varname]] <- list(median=median,\n                              mad=mad,\n                              mean=mean,\n                              sd=sd,\n                              CI_values=CI_values,\n                              MPE=MPE,\n                              MPE_values=MPE_values,\n                              posterior=posterior,\n                              text=text)\n\n  }\n\n\n  # Effect size\n  # -------------\n  if (Effect_Size==T){\n    print(\"Interpreting effect size following Cohen (1977, 1988)... Make sure your variables were standardized!\")\n\n    EffSizes <- data.frame()\n    for (varname in varnames){\n      posterior <- posteriors[, varname]\n    # Compute the probabilities\n      verylarge_neg <- length(posterior[posterior <= -1.30])/length(posterior)\n      large_neg <- length(posterior[posterior > -1.30 & posterior <= -0.80])/length(posterior)\n      medium_neg <- length(posterior[posterior > -0.80 & posterior <= -0.50])/length(posterior)\n      small_neg <- length(posterior[posterior > -0.50 & posterior <= -0.20])/length(posterior)\n      verysmall_neg <- length(posterior[posterior > -0.20 & posterior < 0])/length(posterior)\n\n      verylarge_pos <- length(posterior[posterior >= 1.30])/length(posterior)\n      large_pos <- length(posterior[posterior < 1.30 & posterior >= 0.80])/length(posterior)\n      medium_pos <- length(posterior[posterior < 0.80 & posterior >= 0.50])/length(posterior)\n      small_pos <- length(posterior[posterior < 0.50 & posterior >= 0.20])/length(posterior)\n      verysmall_pos <- length(posterior[posterior < 0.20 & posterior > 0])/length(posterior)\n\n      EffSize <- data.frame(Direction=c(\"Negative\", \"Negative\", \"Negative\", \"Negative\", \"Negative\", \"Positive\", \"Positive\", \"Positive\", \"Positive\", \"Positive\"),\n                                Size=c(\"VeryLarge\", \"Large\", \"Medium\", \"Small\", \"VerySmall\", \"VerySmall\", \"Small\", \"Medium\", \"Large\", \"VeryLarge\"),\n                                Probability=c(verylarge_neg, large_neg, medium_neg, small_neg, verysmall_neg, verysmall_pos, small_pos, medium_pos, large_pos, verylarge_pos))\n\n      EffSize$Probability[is.na(EffSize$Probability)] <- 0\n      EffSize$Variable <- varname\n\n      EffSizes <- rbind(EffSizes, EffSize)\n\n      if(mean(posterior) >= 0){\n        opposite_prob <- sum(EffSize$Probability[EffSize$Direction==\"Negative\"])\n        if (length(posterior[posterior > 0])>0){\n          opposite_max <- min(posterior[posterior > 0])\n        } else{\n          opposite_max <- 0\n        }\n        verylarge <- verylarge_pos\n        large <- large_pos\n        medium <- medium_pos\n        small <- small_pos\n        verysmall <- verysmall_pos\n      } else{\n        opposite_prob <- sum(EffSize$Probability[EffSize$Direction==\"Positive\"])\n        if (length(posterior[posterior > 0])>0){\n        opposite_max <- max(posterior[posterior > 0])\n        } else{\n          opposite_max <- 0\n        }\n        verylarge <- verylarge_neg\n        large <- large_neg\n        medium <- medium_neg\n        small <- small_neg\n        verysmall <- verysmall_neg\n      }\n\n      EffSize_text <- paste(\"Based on Cohen (1988) recommandations, there is a probability of \", round(verylarge*100, 2), \"% that this effect size is very large, \", round(large*100, 2), \"% that this effect size is large, \", round(medium*100, 2), \"% that this effect size is medium, \", round(small*100, 2), \"% that this effect size is small, \", round(verysmall*100, 2), \"% that this effect is very small and \", round(opposite_prob*100, 2), \"% that it has an opposite direction (between 0 and \", signif(opposite_max, 2), \").\", sep=\"\")\n      values[[varname]]$EffSize <- EffSize\n      values[[varname]]$EffSize_text <- EffSize_text\n\n      values[[varname]]$EffSize_VL <- verylarge\n      values[[varname]]$EffSize_L <- large\n      values[[varname]]$EffSize_M <- medium\n      values[[varname]]$EffSize_S <- small\n      values[[varname]]$EffSize_VS <- verysmall\n      values[[varname]]$EffSize_O <- opposite_prob\n\n    }\n    }\n\n\n  # Summary\n  # -------------\n  MPEs <- c()\n  for (varname in names(values)){\n    MPEs <- c(MPEs, values[[varname]]$MPE)\n  }\n  medians <- c()\n  for (varname in names(values)){\n    medians <- c(medians, values[[varname]]$median)\n  }\n  mads <- c()\n  for (varname in names(values)){\n    mads <- c(mads, values[[varname]]$mad)\n  }\n  means <- c()\n  for (varname in names(values)){\n    means <- c(means, values[[varname]]$mean)\n  }\n  sds <- c()\n  for (varname in names(values)){\n    sds <- c(sds, values[[varname]]$sd)\n  }\n  CIs <- c()\n  for (varname in names(values)){\n    CIs <- c(CIs, values[[varname]]$CI_values)\n  }\n\n  summary <- data.frame(Variable=names(values), MPE=MPEs, Median=medians, MAD=mads, Mean=means, SD=sds, CI_lower=CIs[seq(1, length(CIs), 2)], CI_higher=CIs[seq(2, length(CIs), 2)])\n\n  if (Effect_Size==T){\n    EffSizes <- data.frame()\n    for (varname in names(values)){\n      Current <- data.frame(Very_Large=values[[varname]]$EffSize_VL, Large=values[[varname]]$EffSize_L, Medium=values[[varname]]$EffSize_M, Small=values[[varname]]$EffSize_S, Very_Small=values[[varname]]$EffSize_VS, Opposite=values[[varname]]$EffSize_O)\n      EffSizes <- rbind(EffSizes, Current)\n    }\n    summary <- cbind(summary, EffSizes)\n  }\n\n\n\n  # Text\n  # -------------\n  # Model\n  info <- paste(\"We fitted a Markov Chain Monte Carlo [type] model to predict [Y] with [X] (formula =\", fit$formula, \"). Priors were set as follow: [INSERT INFO ABOUT PRIORS].\", sep=\"\")\n\n  # Coefs\n  coefs_text <- c()\n  for (varname in names(values)){\n    coefs_text <- c(coefs_text, values[[varname]]$text)\n    if (Effect_Size==T){\n    coefs_text <- c(coefs_text, values[[varname]]$EffSize_text)\n    }\n  }\n  text <- c(info, coefs_text)\n\n\n\n  # Plot\n  # -------------\n  plot <- posteriors[varnames] %>%\n    # select(-`(Intercept)`) %>%\n    gather() %>%\n    rename_(Variable=\"key\", Coefficient=\"value\") %>%\n    ggplot(aes_string(x=\"Variable\", y=\"Coefficient\", fill=\"Variable\")) +\n    geom_violin() +\n    geom_boxplot(fill=\"grey\", alpha=0.3, outlier.shape=NA) +\n    stat_summary(fun.y = mean, geom = \"errorbar\", aes_string(ymax = \"..y..\", ymin = \"..y..\"), width = .75, linetype = \"dashed\", colour=\"red\") +\n    geom_hline(aes(yintercept=0)) +\n    theme_classic() +\n    coord_flip() +\n    scale_fill_brewer(palette=\"Set1\") +\n    scale_colour_brewer(palette=\"Set1\")\n\n\n  output <- list(text=text, plot=plot, summary=summary, values=values)\n\n  class(output) <- c(\"psychobject\", \"list\")\n  return(output)\n}\n",
    "created" : 1502184707034.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4121663340",
    "id" : "C1A0E54F",
    "lastKnownWriteTime" : 1504186287,
    "last_content_update" : 1504186287989,
    "path" : "D:/Programs/Dropbox/RECHERCHE/N/psycho.R/R/analyze.stanreg.R",
    "project_path" : "R/analyze.stanreg.R",
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}